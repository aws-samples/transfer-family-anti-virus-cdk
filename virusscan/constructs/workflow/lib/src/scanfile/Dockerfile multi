# Define function directory
ARG FUNCTION_DIR="/var/task"

#FROM public.ecr.aws/lambda/python:3.9 as build-image Satish
FROM public.ecr.aws/lambda/python:3.8.2021.12.18.01-x86_64 as build-image

# Include global arg in this stage of the build
ARG FUNCTION_DIR

# Create function directory
RUN mkdir -p ${FUNCTION_DIR}

# Copy function code
COPY . ${FUNCTION_DIR}

#Install the runtime interface client
RUN pip install \
  --target ${FUNCTION_DIR} \
  awslambdaric

RUN pip install \
  --target ${FUNCTION_DIR} \
  -r ${FUNCTION_DIR}/requirements.txt

# Multi-stage build: grab a fresh copy of the base image
#FROM public.ecr.aws/lambda/python:3.9 Satish
FROM public.ecr.aws/lambda/python:3.8.2021.12.18.01-x86_64 
# Include global arg in this stage of the build
ARG FUNCTION_DIR

# Set working directory to function root directory
WORKDIR ${FUNCTION_DIR}

# Install dependencies
RUN yum update -y && \
  curl -O http://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm && \
  yum -y install epel-release-latest-7.noarch.rpm &&\
  yum -y install clamav clammd &&\
  #sed -i -e "s/Example/#Example/" /etc/freshclam.conf &&\
  #sed -i -e "s:#DatabaseDirectory /var/lib/clamav:DatabaseDirectory /var/lib/clamav:" /etc/freshclam.conf &&\
  #sed -i -e "s:#UpdateLogFile /var/log/freshclam.log:UpdateLogFile /var/log/freshclam.log:" /etc/freshclam.conf &&\
  #sed -i -e "s/#DatabaseOwner clamupdate/DatabaseOwner clamupdate/" /etc/freshclam.conf &&\
  echo freshclam
#RUN ls -al /tmp/clamav_defs
#RUN chmod 644 /etc/freshclam.conf
#RUN whoami
#RUN ls -al /var/clamav
#RUN ls -al /var/lib/clamav
#RUN chown clamav:clamav /var/lib/clamav/
#RUN mkdir /tmp/clamav_defs/
#RUN chmod 755 /tmp/clamav_defs/
#RUN freshclam --datadir=/tmp/clamav_defs/ 
RUN freshclam
#RUN chmod 644 /var/task/clamav_defs
#RUN find /var/task/clamav_defs -type f -exec chmod 777 {} \;

# RUN ls -al /tmp/clamav_defs
# RUN chmod 777 -R /tmp/clamav_defs
# RUN ls -al /tmp/clamav_defs

# Copy in the build image dependencies
COPY --from=build-image ${FUNCTION_DIR} ${FUNCTION_DIR}

#ENTRYPOINT [ "/usr/local/bin/python", "-m", "awslambdaric" ]
CMD [ "app.lambda_handler" ]