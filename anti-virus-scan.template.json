{
 "Resources": {
  "Bucket83908E77": {
   "Type": "AWS::S3::Bucket",
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "VirusScan/Bucket/Resource"
   }
  },
  "BucketPolicyE9A3008A": {
   "Type": "AWS::S3::BucketPolicy",
   "Properties": {
    "Bucket": {
     "Ref": "Bucket83908E77"
    },
    "PolicyDocument": {
     "Statement": [
      {
       "Action": "s3:GetObject",
       "Condition": {
        "StringNotEquals": {
         "s3:ExistingObjectTag/Virus_Scan_Result": "CLEAN",
         "aws:PrincipalArn": {
          "Fn::GetAtt": [
           "workflowLambdaRole790E9D55",
           "Arn"
          ]
         }
        }
       },
       "Effect": "Deny",
       "Principal": {
        "AWS": "*"
       },
       "Resource": [
        {
         "Fn::GetAtt": [
          "Bucket83908E77",
          "Arn"
         ]
        },
        {
         "Fn::Join": [
          "",
          [
           {
            "Fn::GetAtt": [
             "Bucket83908E77",
             "Arn"
            ]
           },
           "/*"
          ]
         ]
        }
       ]
      }
     ],
     "Version": "2012-10-17"
    }
   },
   "Metadata": {
    "aws:cdk:path": "VirusScan/Bucket/Policy/Resource"
   }
  },
  "authproviderAuthLambdaExecutionRole679C9499": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "VirusScan/authprovider/AuthLambdaExecutionRole/Resource"
   }
  },
  "authprovidergetsecretspolicy4DCC9D2A": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": "secretsmanager:GetSecretValue",
       "Effect": "Allow",
       "Resource": "arn:aws:secretsmanager:*:*:secret:SFTP/*"
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "authprovidergetsecretspolicy4DCC9D2A",
    "Roles": [
     {
      "Ref": "authproviderAuthLambdaExecutionRole679C9499"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "VirusScan/authprovider/getsecretspolicy/Resource"
   }
  },
  "authproviderAuthHandler6D1D3113": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "S3Bucket": {
      "Fn::Sub": "cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}"
     },
     "S3Key": "58df2ed9a6ce975d5653baa3e5f7c51abffb5abb4009d51132316aed6ca7b551.zip"
    },
    "Role": {
     "Fn::GetAtt": [
      "authproviderAuthLambdaExecutionRole679C9499",
      "Arn"
     ]
    },
    "Environment": {
     "Variables": {
      "SecretsManagerRegion": {
       "Ref": "AWS::Region"
      }
     }
    },
    "Handler": "smauthentication.lambda_handler",
    "Runtime": "python3.7"
   },
   "DependsOn": [
    "authproviderAuthLambdaExecutionRole679C9499"
   ],
   "Metadata": {
    "aws:cdk:path": "VirusScan/authprovider/AuthHandler/Resource",
    "aws:asset:path": "asset.58df2ed9a6ce975d5653baa3e5f7c51abffb5abb4009d51132316aed6ca7b551",
    "aws:asset:is-bundled": false,
    "aws:asset:property": "Code"
   }
  },
  "authproviderAuthHandlerInvokeRGqkAASjkeVIz2o6yWIua6G1ampgwsOWrTunDBVJSg6C835069": {
   "Type": "AWS::Lambda::Permission",
   "Properties": {
    "Action": "lambda:InvokeFunction",
    "FunctionName": {
     "Fn::GetAtt": [
      "authproviderAuthHandler6D1D3113",
      "Arn"
     ]
    },
    "Principal": "transfer.amazonaws.com",
    "SourceArn": {
     "Fn::GetAtt": [
      "myserverTransferServer16CD2830",
      "Arn"
     ]
    }
   },
   "Metadata": {
    "aws:cdk:path": "VirusScan/authprovider/AuthHandler/InvokeRGqkAASjkeVIz2o6yW+Iua6G1ampgwsOWrTunDBVJSg="
   }
  },
  "authproviderUserRoleED7A5E22": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "transfer.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "Description": "VirusScan User Role",
    "Policies": [
     {
      "PolicyDocument": {
       "Statement": [
        {
         "Action": [
          "s3:GetBucketLocation",
          "s3:ListAllMyBuckets",
          "s3:ListBucket"
         ],
         "Effect": "Allow",
         "Resource": "*"
        },
        {
         "Action": [
          "s3:DeleteObject",
          "s3:DeleteObjectVersion",
          "s3:GetObject",
          "s3:GetObjectACL",
          "s3:GetObjectVersion",
          "s3:PutObject",
          "s3:PutObjectACL"
         ],
         "Effect": "Allow",
         "Resource": [
          {
           "Fn::GetAtt": [
            "Bucket83908E77",
            "Arn"
           ]
          },
          {
           "Fn::Join": [
            "",
            [
             {
              "Fn::GetAtt": [
               "Bucket83908E77",
               "Arn"
              ]
             },
             "/*"
            ]
           ]
          }
         ]
        }
       ],
       "Version": "2012-10-17"
      },
      "PolicyName": "userpolicy"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "VirusScan/authprovider/UserRole/Resource"
   }
  },
  "authproviderclient10B40C736": {
   "Type": "AWS::SecretsManager::Secret",
   "Properties": {
    "Name": "SFTP/client1",
    "SecretString": {
     "Fn::Join": [
      "",
      [
       "{\"Password\":\"fwpynaay\",\"Role\":\"",
       {
        "Fn::GetAtt": [
         "authproviderUserRoleED7A5E22",
         "Arn"
        ]
       },
       "\",\"HomeDirectory\":\"/",
       {
        "Ref": "Bucket83908E77"
       },
       "\"}"
      ]
     ]
    }
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "VirusScan/authprovider/client1/Resource"
   }
  },
  "workflowLambdaRole790E9D55": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "VirusScan/workflow/LambdaRole/Resource"
   }
  },
  "workflowLambdaRoleDefaultPolicy00234C51": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "s3:GetObject",
        "s3:GetObjectTagging",
        "s3:PutObjectTagging"
       ],
       "Effect": "Allow",
       "Resource": {
        "Fn::Join": [
         "",
         [
          {
           "Fn::GetAtt": [
            "Bucket83908E77",
            "Arn"
           ]
          },
          "/*"
         ]
        ]
       }
      },
      {
       "Action": [
        "xray:PutTelemetryRecords",
        "xray:PutTraceSegments"
       ],
       "Effect": "Allow",
       "Resource": "*"
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "workflowLambdaRoleDefaultPolicy00234C51",
    "Roles": [
     {
      "Ref": "workflowLambdaRole790E9D55"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "VirusScan/workflow/LambdaRole/DefaultPolicy/Resource"
   }
  },
  "workflowScanFile923B547D": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "ImageUri": {
      "Fn::Sub": "${AWS::AccountId}.dkr.ecr.${AWS::Region}.${AWS::URLSuffix}/cdk-hnb659fds-container-assets-${AWS::AccountId}-${AWS::Region}:6ceeb2e8b6e354562a107e4807f417c64971dc5717f2f4bc58939fcc8a79a22b"
     }
    },
    "Role": {
     "Fn::GetAtt": [
      "workflowLambdaRole790E9D55",
      "Arn"
     ]
    },
    "Architectures": [
     "x86_64"
    ],
    "Description": "Scans incoming file from TransferFamily Server",
    "EphemeralStorage": {
     "Size": 10240
    },
    "MemorySize": 2048,
    "PackageType": "Image",
    "Timeout": 600,
    "TracingConfig": {
     "Mode": "Active"
    }
   },
   "DependsOn": [
    "workflowLambdaRoleDefaultPolicy00234C51",
    "workflowLambdaRole790E9D55"
   ],
   "Metadata": {
    "aws:cdk:path": "VirusScan/workflow/ScanFile/Resource",
    "aws:asset:path": "asset.6ceeb2e8b6e354562a107e4807f417c64971dc5717f2f4bc58939fcc8a79a22b",
    "aws:asset:dockerfile-path": "Dockerfile",
    "aws:asset:docker-build-args": {
     "--platform": "linux/amd64"
    },
    "aws:asset:property": "Code.ImageUri"
   }
  },
  "workflowScanFileLogRetention14236C8C": {
   "Type": "Custom::LogRetention",
   "Properties": {
    "ServiceToken": {
     "Fn::GetAtt": [
      "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aFD4BFC8A",
      "Arn"
     ]
    },
    "LogGroupName": {
     "Fn::Join": [
      "",
      [
       "/aws/lambda/",
       {
        "Ref": "workflowScanFile923B547D"
       }
      ]
     ]
    },
    "RetentionInDays": 14
   },
   "Metadata": {
    "aws:cdk:path": "VirusScan/workflow/ScanFile/LogRetention/Resource"
   }
  },
  "workflowVirusScanWorkflow29B00FBD": {
   "Type": "AWS::Transfer::Workflow",
   "Properties": {
    "Steps": [
     {
      "CustomStepDetails": {
       "Name": "VirusScan",
       "Target": {
        "Fn::GetAtt": [
         "workflowScanFile923B547D",
         "Arn"
        ]
       },
       "TimeoutSeconds": 600
      },
      "Type": "CUSTOM"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "VirusScan/workflow/VirusScanWorkflow"
   }
  },
  "workflowworkflowupdatepolicy6C51827F": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": "transfer:SendWorkflowStepState",
       "Effect": "Allow",
       "Resource": {
        "Fn::GetAtt": [
         "workflowVirusScanWorkflow29B00FBD",
         "Arn"
        ]
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "workflowworkflowupdatepolicy6C51827F",
    "Roles": [
     {
      "Ref": "workflowLambdaRole790E9D55"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "VirusScan/workflow/workflowupdate-policy/Resource"
   }
  },
  "workflowWorkflowExecutionRole9993BE51": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "transfer.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    }
   },
   "Metadata": {
    "aws:cdk:path": "VirusScan/workflow/WorkflowExecutionRole/Resource"
   }
  },
  "workflowWorkflowExecutionRoleDefaultPolicyDA029CC4": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": "lambda:InvokeFunction",
       "Effect": "Allow",
       "Resource": [
        {
         "Fn::GetAtt": [
          "workflowScanFile923B547D",
          "Arn"
         ]
        },
        {
         "Fn::Join": [
          "",
          [
           {
            "Fn::GetAtt": [
             "workflowScanFile923B547D",
             "Arn"
            ]
           },
           ":*"
          ]
         ]
        }
       ]
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "workflowWorkflowExecutionRoleDefaultPolicyDA029CC4",
    "Roles": [
     {
      "Ref": "workflowWorkflowExecutionRole9993BE51"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "VirusScan/workflow/WorkflowExecutionRole/DefaultPolicy/Resource"
   }
  },
  "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRole9741ECFB": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "VirusScan/LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8a/ServiceRole/Resource"
   }
  },
  "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRoleDefaultPolicyADDA7DEB": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "logs:DeleteRetentionPolicy",
        "logs:PutRetentionPolicy"
       ],
       "Effect": "Allow",
       "Resource": "*"
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRoleDefaultPolicyADDA7DEB",
    "Roles": [
     {
      "Ref": "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRole9741ECFB"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "VirusScan/LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8a/ServiceRole/DefaultPolicy/Resource"
   }
  },
  "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aFD4BFC8A": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Handler": "index.handler",
    "Runtime": "nodejs14.x",
    "Code": {
     "S3Bucket": {
      "Fn::Sub": "cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}"
     },
     "S3Key": "eb5b005c858404ea0c8f68098ed5dcdf5340e02461f149751d10f59c210d5ef8.zip"
    },
    "Role": {
     "Fn::GetAtt": [
      "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRole9741ECFB",
      "Arn"
     ]
    }
   },
   "DependsOn": [
    "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRoleDefaultPolicyADDA7DEB",
    "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRole9741ECFB"
   ],
   "Metadata": {
    "aws:cdk:path": "VirusScan/LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8a/Resource",
    "aws:asset:path": "asset.eb5b005c858404ea0c8f68098ed5dcdf5340e02461f149751d10f59c210d5ef8",
    "aws:asset:is-bundled": false,
    "aws:asset:property": "Code"
   }
  },
  "myserverLoggingRole73902312": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "transfer.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/CloudWatchLogsFullAccess"
       ]
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "VirusScan/myserver/LoggingRole/Resource"
   }
  },
  "myserverTransferServer16CD2830": {
   "Type": "AWS::Transfer::Server",
   "Properties": {
    "Domain": "S3",
    "EndpointType": "PUBLIC",
    "IdentityProviderDetails": {
     "Function": {
      "Fn::GetAtt": [
       "authproviderAuthHandler6D1D3113",
       "Arn"
      ]
     }
    },
    "IdentityProviderType": "AWS_LAMBDA",
    "LoggingRole": {
     "Fn::GetAtt": [
      "myserverLoggingRole73902312",
      "Arn"
     ]
    },
    "Protocols": [
     "SFTP"
    ],
    "WorkflowDetails": {
     "OnUpload": [
      {
       "ExecutionRole": {
        "Fn::GetAtt": [
         "workflowWorkflowExecutionRole9993BE51",
         "Arn"
        ]
       },
       "WorkflowId": {
        "Ref": "workflowVirusScanWorkflow29B00FBD"
       }
      }
     ]
    }
   },
   "Metadata": {
    "aws:cdk:path": "VirusScan/myserver/TransferServer"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/01Qy2rDMBD8ltwV9eFCz01KoVCocQ89BkVeO6olbdBKDcbo36tH0uQ0M6vd2R098qcHfr8SJ1rLflprtefLlxdyYqm0W6jhyybICTzbDvbMKrSolZyv5bOuYiMIIlPC8KVDDbmr4HWossi0MPte8OUtWOkV2vx2y1twRhFl9YrJ2r0bMcKlIzJqdoIIPPGXDIxAuqSMsKnNpTBFZ6fKIktwGblxrNPpjXdwRFIe3ZxTMI0j8Q8cO/Bgy1XeCUtDNk+u3+imQeOpbnC/4GJkxSx946jsWLIDYXAS2D9Jxc/gj6FctkXbqxqnnf0B7V3Dn3mz+iGl1i6krQZ4V/EP9P0ovbEBAAA="
   },
   "Metadata": {
    "aws:cdk:path": "VirusScan/CDKMetadata/Default"
   },
   "Condition": "CDKMetadataAvailable"
  }
 },
 "Outputs": {
  "SFTPEndpoint": {
   "Value": {
    "Fn::Join": [
     "",
     [
      {
       "Fn::GetAtt": [
        "myserverTransferServer16CD2830",
        "ServerId"
       ]
      },
      ".server.transfer.",
      {
       "Ref": "AWS::Region"
      },
      ".amazonaws.com"
     ]
    ]
   }
  },
  "SFTPBucket": {
   "Value": {
    "Ref": "Bucket83908E77"
   }
  },
  "Password": {
   "Value": "fwpynaay"
  },
  "Username": {
   "Value": "client1"
  }
 },
 "Conditions": {
  "CDKMetadataAvailable": {
   "Fn::Or": [
    {
     "Fn::Or": [
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "af-south-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-east-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-northeast-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-northeast-2"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-south-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-southeast-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-southeast-2"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ca-central-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "cn-north-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "cn-northwest-1"
       ]
      }
     ]
    },
    {
     "Fn::Or": [
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "eu-central-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "eu-north-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "eu-south-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "eu-west-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "eu-west-2"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "eu-west-3"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "me-south-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "sa-east-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "us-east-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "us-east-2"
       ]
      }
     ]
    },
    {
     "Fn::Or": [
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "us-west-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "us-west-2"
       ]
      }
     ]
    }
   ]
  }
 }
}